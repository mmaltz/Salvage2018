---
title: "AMF"
author: "M. Maltz"
date: '20180927'
output:
  html_document: default
  pdf_document: default
---  

### Logic   
  Salvage topsoil was removed from a donor site and delivered to three recipient sites in 2015. We sampled all sites (Donor and recipients) prior to topsoil delivery and sequenced AM Fungi from all sites in 2015 and 2017 from manipulative plots, set up in a randomized block design at each site with: control treatments (no topsoil added), a dusting of topsoil, and three levels of topsoil thicknesses (2", 4" and 6" thick layers of this topsoil, originating from the donor site)), delivered to all recipient sites).
```{r}
knitr::opts_chunk$set(cache=TRUE, tidy=TRUE, error = FALSE, eval = TRUE, message = FALSE, warning = FALSE, rows.print=5, cols.min.print=4, fig.width=6, fig.height=4.5)
```
### Questions:
###**Q1: 
  Propagule determination: Do AM fungal communities resemble the donor site, regardless of where soil was delivered? Is provenance a driver of AM fungal community composition?

###**Q2: 
  Environmental filtering: Do AM fungal communities resemble the recipient sites, and are more dissimilar to the AM fungal communities from the donor site?

###**Q3: 
  Propagule pressure: Do AM fungal communities resemble the donor site more in higher level topsoil treatments, than they do in the control or dusted sites?
  
####**Outputs:** 

#Analysis of similarity:

  Determine the similarity of AMF communities at each recipient site to the donor site, from where topsoils originated from. 
    Generate heatmaps with distances, to visually determine - which sites/samples are more similar to each other, and which are more dissimilar. 
    Generate NMDS / Pcoa, plotted with Year as shapes and Sites as colors, and Description as ...?
    Run permanova
      Do AM fungal communities at each site resemble the recipient sites, and are they more dissimilar to the donor sites?
      
#Functional group richness:

  Determine the richness of AMF functional groups in the donor site, from where topsoils originated from, and in the recipient sites pre-topsoil delivery (pre-treatment), and post-topsoil delivery (post-treatment)
  
#Taxonomic diversity:

  Determine the OTU taxa richness (alpha diversity) of AMF communities in the donor site, from where topsoils originated from, and in the recipient sites pre-topsoil delivery (pre-treatment), and post-topsoil delivery (post-treatment).
  Determine the beta diversity of AMF communities in the donor site, from where topsoils originated from, and in the recipient sites pre-topsoil delivery (pre-treatment), and post-topsoil delivery (post-treatment).
  
#Topsoil level treatments

  Propagule pressure: Do AM fungal communities resemble the donor site more in thicker topsoil layer treatments than they do in the control or dusted sites?
  Are the sites with Treat groups = S, more similar to the donor site than F, and are treatment groups S and F more similar to the donor site than T? Is this relationship clinal, with S being the thickest and most similar to donor site, followed by F, and then by T.
  TO FIGURE OUT - how to address this question statistically??multiple regression with Treat on the X and similarity to Donor Site on the Y?? A permanova with multiple comparisons?
  
```{r}
knitr::opts_chunk$set(cache=TRUE, tidy=TRUE, error = FALSE, eval = TRUE, message = FALSE, warning = FALSE, rows.print=5, cols.min.print=4, fig.width=6, fig.height=4.5)
```
Load Required Packages
```{r}
library(tidyverse)
library(dplyr) ## for data wrangling - %>% function
library(reshape2)  ##melt and cast data
library(ggplot2) # plotting
library(data.table)
library(stringr)
library(tidyr) # 'separate' function
library(readxl) #read xlsx files into r on mac computer
library(vegan) # dissimilarity matrix, permanova functions
library(magrittr)
library(cowplot)
library(formatR)


date<-format(Sys.time(), '%Y%b%d')
date

```

** the following is adapted from 2017-07-07_Chapter_2_SSU_IntialClean **  

Import data files
```{r}
# read in OTU table
ssu<-fread('CSS_table_sorted.txt')
str(ssu)

## mapping data
metassu<-fread('mapSal18927.txt', header=TRUE)
metassu$Year<-as.character(metassu$Year)
metassu$Rep<-as.factor(metassu$Rep)
metassu$Treat<-as.factor(metassu$Treat)
metassu$HL<-as.numeric(metassu$HL)
str(metassu)
```
Clean SSU headers  
```{r}
colnames(ssu)
head(ssu$taxonomy)

# rename columns
names(ssu)[1] <- 'ssuotu' #rename first column
names(ssu)[names(ssu)=='taxonomy'] <- 'ssutaxonomy' # rename column that is currently called taxonomy

# split taxonomy column
?str_match
ssu$ssukingdom<-str_match(ssu$ssutaxonomy, "k__(.*?);")[,2]
ssu$ssuphylum<-str_match(ssu$ssutaxonomy, "p__(.*?);")[,2]
ssu$ssuclass<-str_match(ssu$ssutaxonomy, "c__(.*?);")[,2]
ssu$ssuorder<-str_match(ssu$ssutaxonomy, "o__(.*?);")[,2]
ssu$ssufamily<-str_match(ssu$ssutaxonomy, "f__(.*?);")[,2]
ssu$ssugenus<-str_match(ssu$ssutaxonomy, "g__(.*?);")[,2]
ssu$ssuspecies<-str_match(ssu$ssutaxonomy, "s__(.*?)$")[,2]

unique(ssu$ssuspecies)
colnames(ssu)
ssu.save<-ssu
#View(ssu)

#remove Geosiphonaceae
unique(ssu$ssufamily)
drop.family <- c("Geosiphonaceae")
ssu  <- ssu[-which(ssu$ssufamily %in% drop.family),]



#remove no blast hits
unique(ssu$ssutaxonomy)
drop <-c("No blast hit")
ssu  <- ssu[-which(ssu$ssutaxonomy %in% drop),]

## alternatively, can use filtering to drop these and avoid rewriting things 
ssu <- ssu.save%>%filter(ssufamily != "Geosiphonaceae" & ssutaxonomy != "No blast hit")

ssu <- ssu[complete.cases(ssu),]
unique(ssu$ssuspecies)
```
Add in functional groups 

```{r Take data from wide to long and renaming variables}
ssul <-melt(ssu, variable.name='ID',value.name='ssureads')
str(ssul) 


```

```{r include=FALSE, eval=FALSE}
ssul <-melt(ssu, variable.name='ID',value.name='ssureads')
str(ssul) 

```
OTU richnesses and read abundance for each taxonomic group 

Below is in format for graphing
```{r}
ssuspeciesREADRICH<- data.frame(ssul %>%
                                group_by(ID,ssuspecies) %>%
                                summarise(OTU_Richness_Sample = length(unique(ssuotu[ssureads>0])),
                                         Read_Abundance_Sample = sum(ssureads)))


```

Make SSU data frame with species level OTU richness and Read abundance for each species
```{r}
ssuSpecific <- data.frame(ssul %>%
                          group_by(ID, ssuspecies) %>%
                          summarise(species_OTU_Richness = length(unique(ssuotu[ssureads>0])), 
                                    species_Read_Abundance = sum(ssureads)))

```
Add metadata into ssu species
```{r}
colnames(metassu) # need to edit for appropriate headers
names(metassu)[names(metassu) == 'SampleID2'] <- 'ID'

ssuSpecific<-ssuSpecific%>%
  left_join(metassu, by='ID')
str(ssuSpecific)

```

Adds meta data to data for box plot
```{r}
ssuspeciesREADRICH<-ssuspeciesREADRICH%>%
  left_join(metassu, by='ID')
str(ssuspeciesREADRICH)  

filename<-paste0(date, '_ssu_genera_read_rich.csv')
write.csv(ssuspeciesREADRICH, file = filename, row.names=FALSE)
```
#move ID to single line and species to the length
```{r}
###For ssufamily, moves ID to single line and species to the length
LssuspeciesOTURICH <- dcast(ssuSpecific, ID ~ ssuspecies, value.var = "species_OTU_Richness",  fun.aggregate = sum )
LssuspeciesOTUREAD <- dcast(ssuSpecific, ID ~ ssuspecies, value.var = "species_Read_Abundance",  fun.aggregate = sum )

head(LssuspeciesOTUREAD)
```

Genera reads and richness together
###WORKED ON THIS 20180826

###REPLACED Functional.Group with ssuspecies 
###changed genus to species in this iteration

```{r} 
ssuspeciesREADRICHlong<- data.frame(ssul %>%
                                group_by(ID) %>%
                                summarise(OTU_Richness_Sample = length(unique(ssuotu[ssureads>0])),
                                NES27_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="NES27"])),
                                MH3_B_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="MH3_B"])),
                                Acau16_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Acau16"])),
                                MO_G47_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="MO_G47"])),
                                laccatum_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="laccatum"])),
                                acnaGlo2_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="acnaGlo2"])),
                                MO_Ar1_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="MO_Ar1"])),
                                leptoticha_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="leptoticha"])),
                            Whitfield_type_7_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Whitfield_type_7"])),
                  Torrecillas12b_Glo_G5_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Torrecillas12b_Glo_G5"])),
               Sanchez_Castro12b_GLO12_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Sanchez_Castro12b_GLO12"])),
                                Winther07_D_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Winther07_D"])),
                                MO_G18_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="MO_G18"])),
                                intraradices_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="intraradices"])),
                                Alguacil12a_Para_1_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Alguacil12a_Para_1"])),
                                Douhan9_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Douhan9"])),
                                Alguacil12b_GLO_G3_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Alguacil12b_GLO_G3"])),
                               Glo39_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Glo39"])),
               
                Alguacil10_Glo1_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Alguacil10_Glo1"])),
               
               Ligrone07_sp_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Ligrone07_sp"])),
               
               PT6_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="PT6"])),
               MO_G41_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="MO_G41"])),
               MO_GB1_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="MO_GB1"])),
               A1_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="A1"])),
               Liu2012b_Phylo_5_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Liu2012b_Phylo_5"])),
               Yamato09_C1_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Yamato09_C1"])),
               acnaGlo7_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="acnaGlo7"])),
               MO_G7_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="MO_G7"])),
               Alguacil10_Glo6_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Alguacil10_Glo6"])),
               
               Alguacil12b_PARA1_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Alguacil12b_PARA1"])),
               Glo58_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Glo58"])),
               lamellosum_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="lamellosum"])),
               VeGlo18_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="VeGlo18"])),
               Liu2012a_Ar_1_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Liu2012a_Ar_1"])),
               Div_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Div"])),
               fennica_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="fennica"])),
               Voyriella_parviflora_symbiont_type_1_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Voyriella_parviflora_symbiont_type_1"])),
               Para1_OTU2_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Para1_OTU2"])),
               Whitfield_type_3_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Whitfield_type_3"])),
               
               
               Aca_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Aca"])),
               MO_G20_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="MO_G20"])),
               Glo7_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Glo7"])),
               MO_GC1_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="MO_GC1"])),
               Winther07_B_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Winther07_B"])),
               mosseae_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="mosseae"])),
               caledonium_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="caledonium"])),
               brasilianum_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="brasilianum"])),
               Alguacil09b_Glo_G8_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Alguacil09b_Glo_G8"])),
               Schechter08_Arch1_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Schechter08_Arch1"])),
                Wirsel_OTU21_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Wirsel_OTU21"])),
               
               
               
               Glo71_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Glo71"])),
              spurca_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="spurca"])),
               Glo59_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Glo59"])),
               Wirsel_OTU16_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Wirsel_OTU16"])),
               Glo32_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="Glo32"])),
               MO_A8_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="MO_A8"])),
               MO_G27_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="MO_G27"])),
               MO_G5_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="MO_G5"])),
              
              
               Glomussp_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="sp" & ssugenus == "Glomus"])),
               Archaeosporasp_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="sp" & ssugenus == "Archaeospora"])),
              
             Diversisporasp_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="sp" & ssugenus == "Diversispora"])),
                Paraglomussp_Richness = length(unique(ssuotu[ssureads>0 & ssuspecies =="sp" & ssugenus == "Paraglomus"])),                
                                
                                NES27_Read_Abundance = sum(ssureads[ssuspecies == "NES27"]),
                                MH3_B_Read_Abundance = sum(ssureads[ssuspecies == "MH3_B"]),
                                Acau16_Read_Abundance = sum(ssureads[ssuspecies == "Acau16"]),
                                MO_G47_Read_Abundance = sum(ssureads[ssuspecies == "MO_G47"]),
                                laccatum_Read_Abundance = sum(ssureads[ssuspecies == "laccatum"]),
                                acnaGlo2_Read_Abundance = sum(ssureads[ssuspecies == "acnaGlo2"]),
                                MO_Ar1 = sum(ssureads[ssuspecies == "MO_Ar1"]),
                                leptoticha_Read_Abundance = sum(ssureads[ssuspecies == "leptoticha"]),
                                
                                Whitfield_type_7_Read_Abundance = sum(ssureads[ssuspecies == "Whitfield_type_7"]),
                                Torrecillas12b_Glo_G5_Read_Abundance = sum(ssureads[ssuspecies == "Torrecillas12b_Glo_G5"]),
                              Sanchez_Castro12b_GLO12_Read_Abundance = sum(ssureads[ssuspecies == "Sanchez_Castro12b_GLO12"]),
                                Winther07_D_Read_Abundance = sum(ssureads[ssuspecies == "Winther07_D"]),
                                MO_G18_Read_Abundance = sum(ssureads[ssuspecies == "MO_G18"]),
                                intraradices_Read_Abundance = sum(ssureads[ssuspecies == "intraradices"]),
                                Alguacil12a_Para_1_Read_Abundance = sum(ssureads[ssuspecies == "Alguacil12a_Para_1"]),
                                Douhan9_Read_Abundance = sum(ssureads[ssuspecies == "Douhan9"]),
                                Alguacil12b_GLO_G3_Read_Abundance = sum(ssureads[ssuspecies == "Alguacil12b_GLO_G3"]),
                                Glo39_Read_Abundance = sum(ssureads[ssuspecies == "Glo39"]),
                                Alguacil10_Glo1_Read_Abundance = sum(ssureads[ssuspecies == "Alguacil10_Glo1"]),
               
               Ligrone07_sp_Read_Abundance = sum(ssureads[ssuspecies == "Ligrone07_sp"]),
               PT6_Read_Abundance = sum(ssureads[ssuspecies == "PT6"]),
               MO_G41_Read_Abundance = sum(ssureads[ssuspecies == "MO_G41"]),
               NES27_Read_Abundance = sum(ssureads[ssuspecies == "MO_GB1"]),
              A1_Read_Abundance = sum(ssureads[ssuspecies == "A1"]),
               Liu2012b_Phylo_5_Read_Abundance = sum(ssureads[ssuspecies == "Liu2012b_Phylo_5"]),
               Yamato09_C1_Read_Abundance = sum(ssureads[ssuspecies == "Yamato09_C1"]),
               NES27_Read_Abundance = sum(ssureads[ssuspecies == "acnaGlo7"]),
               MO_G7_Read_Abundance = sum(ssureads[ssuspecies == "MO_G7"]),
               Alguacil10_Glo6_Read_Abundance = sum(ssureads[ssuspecies == "Alguacil10_Glo6"]),
              
              Alguacil12b_PARA1_Read_Abundance = sum(ssureads[ssuspecies == "Alguacil12b_PARA1"]),
              Glo58_Read_Abundance = sum(ssureads[ssuspecies == "Glo58"]),
              lamellosum_Read_Abundance = sum(ssureads[ssuspecies == "lamellosum"]),
              VeGlo18_Read_Abundance = sum(ssureads[ssuspecies == "VeGlo18"]),
              Liu2012a_Ar_1_Read_Abundance = sum(ssureads[ssuspecies == "Liu2012a_Ar_1"]),
              Div_Read_Abundance = sum(ssureads[ssuspecies == "Div"]),
              fennica_Read_Abundance = sum(ssureads[ssuspecies == "fennica"]),
              Voyriella_parviflora_symbiont_type_1_Read_Abundance = sum(ssureads[ssuspecies == "Voyriella_parviflora_symbiont_type_1"]),
              Para1_OTU2_Read_Abundance = sum(ssureads[ssuspecies == "Para1_OTU2"]),
              Whitfield_type_3_Read_Abundance = sum(ssureads[ssuspecies == "Whitfield_type_3"]),
              
              Aca_Read_Abundance = sum(ssureads[ssuspecies == "Aca"]),
              MO_G20_Read_Abundance = sum(ssureads[ssuspecies == "MO_G20"]),
             Glo7_Read_Abundance = sum(ssureads[ssuspecies == "Glo7"]),
              MO_GC1_Read_Abundance = sum(ssureads[ssuspecies == "MO_GC1"]),
              Winther07_B7_Read_Abundance = sum(ssureads[ssuspecies == "Winther07_B"]),
              mosseae_Read_Abundance = sum(ssureads[ssuspecies == "mosseae"]),
              caledonium_Read_Abundance = sum(ssureads[ssuspecies == "caledonium"]),
              brasilianum_Read_Abundance = sum(ssureads[ssuspecies == "brasilianum"]),
              Alguacil09b_Glo_G8_Read_Abundance = sum(ssureads[ssuspecies == "Alguacil09b_Glo_G8"]),
              Schechter08_Arch1_Read_Abundance = sum(ssureads[ssuspecies == "Schechter08_Arch1"]),
              Wirsel_OTU21_Read_Abundance = sum(ssureads[ssuspecies == "Wirsel_OTU21"]),
             
            Glo71_Read_Abundance = sum(ssureads[ssuspecies == "Glo71"]),
             spurca_Read_Abundance = sum(ssureads[ssuspecies == "spurca"]),
            Glo59_Read_Abundance = sum(ssureads[ssuspecies == "Glo59"]),
             Wirsel_OTU16_Read_Abundance = sum(ssureads[ssuspecies == "Wirsel_OTU16"]),
             Glo32_Read_Abundance = sum(ssureads[ssuspecies == "Glo32"]),
             MO_A8_Read_Abundance = sum(ssureads[ssuspecies == "MO_A8"]),
             MO_G27_Read_Abundance = sum(ssureads[ssuspecies == "MO_G27"]),
             MO_G5_Read_Abundance = sum(ssureads[ssuspecies == "MO_G5"]),
            
             Glomussp_Read_Abundance = sum(ssureads[ssuspecies == "sp"& ssugenus == "Glomus"]),
            Archaeosporasp_Read_Abundance = sum(ssureads[ssuspecies == "sp"& ssugenus == "Archaeospora"]),
            Diversisporasp_Read_Abundance = sum(ssureads[ssuspecies == "sp"& ssugenus == "Diversispora"]),
             Paraglomussp_Read_Abundance = sum(ssureads[ssuspecies == "sp"& ssugenus == "Paraglomus"]),
            
            
             Read_Abundance_Sample = sum(ssureads)))

##View(ssuspeciesREADRICHlong)
ssuspeciesREADRICHlong <- merge(ssuspeciesREADRICHlong, metassu, by = "ID")

filename<-paste0(date, '_ssu_species_read_rich.csv')
write.csv(ssuspeciesREADRICHlong, file = filename, row.names=FALSE)

str(ssuspeciesREADRICHlong)
##View(ssuspeciesREADRICHlong)
```
#Non Unifrac distances, try with bray
###WORK ON THIS
#### Permanova  
  Permanova tests for differences in composition among groups  
    Reminder - permanova is always based on pairwise distances/dissimilarities.  
      Can either nest Treat in Year with Year/Treat
          Or, can restrict permutations within year, using strata='Year'
          Or, can remove Year, and focus on Treat and other grouping varuables, like Site
          
##Also, dist.j<-vegdist(ssuspeciesREADRICHlong[,-1], method='jaccard', na.rm=TRUE)
#USE BRAY #dist.bc<-vegdist(ssuspeciesREADRICHlong[,-1], method='bray', na.rm=TRUE)
##############################################################################################################
######################################
## Part 3 - multivariate community analyses and data visualization
```{r}
library(dplyr)
library(reshape2)
library(tidyr)
library(vegan)
library(ggplot2)# ggplot resource -http://rpubs.com/collnell/ggplot2
library(tidyverse) # useful packages in 1 - dplyr, ggplot2, tidyr +
```
# community matrix at order level with mapping data
#otu_map<-read.csv('/Users/maltz/Desktop/RdataBreathe/otus_by_class.csv')
```{r}
head(ssuspeciesREADRICHlong)
colnames(ssuspeciesREADRICHlong)
```
#Create the comm.grps from ssuspeciesREADRICHlong 
#To make the comm.grps I want the first column (col 1), then I don't want (want to de-select) cols 2 through 22, and then I want the rest of the data = cols 23-30
#This didn't work: 
  comm.grps<-ssuspeciesREADRICHlong%>%dplyr::select('#SampleID':Description) #mapping data
  #heads[1,-c(12:17)]
  ##This will not work because it uses numeric syntax and the text, only use one or the other (only select; or only numeric -c)
  comm.grps<-ssuspeciesREADRICHlong%>%dplyr::select['ID':Description,-c(2:22)] #mapping data
  
  
  #So I used the longhand way of typing out all the column names that I wanted to keep
  
```{r}
?dplyr::select

comm.grps<-ssuspeciesREADRICHlong%>%dplyr::select('ID','Location','Year','Site','Treat','Rep','HL','TSDel','Description') #mapping data
colnames(comm.grps)
```

Make the comm.mat 
each species richness (first - last species richness name)
```{r}
comm.mat<-ssuspeciesREADRICHlong%>%dplyr::select(NES27_Richness:Paraglomussp_Richness) # community matrix - all but mapping data
```
######################################
## comparing ecological communities
# diversity vs composition
# abundance and richness are univariate response variables used to quantify communities
# in multivariate analyses we have these variables for multiple entities
# similarly, multivariate analyses have counterparts in univariate stats - t-test, ANOVA, mutliple regression
## univariate analyses of diversity
```{r}
list.files() #shows what is in folder
  #View(comm.mat)
  str(comm.grps)
  head(comm.grps)
    str(comm.mat)
  head(comm.mat)
```
## does diversity vary across groups?
# compute diversity indices
#indices <- comm.grps
#indices$richness <- rowSums(comm.mat >0)
#indices$shannon <- diversity(comm.mat, index='shannon')
#indices$rarified <- c(rarefy(comm.mat, sample=50)) # rarefied diversity for a given sample size
```{r}
indices <- comm.grps
indices$richness <- rowSums(comm.mat >0)
indices$shannon <- diversity(comm.mat, index='shannon')
#View(indices)
#indices$rarified <- c(rarefy(comm.mat, sample=18103)) # rarefied diversity for a given sample size
```

Subset the data
First subset the site (West Loma) from both 2015 and 2017
```{r subset data from WestLoma}

prevpost.mat=comm.mat[comm.grps$Site=="WL",]
prevpost.grps=comm.grps[comm.grps$Site=="WL",]
distWL.bc<-vegdist(prevpost.mat, method='bray', na.rm=TRUE)
WLTreat.div<-adonis2(distWL.bc~Description, strata= Treat, data=prevpost.grps, permutations = 999, method="bray")
WLTreat.div
```
Next subset the data from the site WL in 2017 with the donor site
```{r donor versus west loma}


dvpostWL.mat=comm.mat[(comm.grps$Site=="WL" & comm.grps$Description=="RecipientPost") | comm.grps$Site=="DS",]
dvpostWL.grps=comm.grps[(comm.grps$Site=="WL" & comm.grps$Description=="RecipientPost") | comm.grps$Site=="DS",]
distDWL.bc<-vegdist(dvpostWL.mat, method='bray', na.rm=TRUE)
DWLTreat.div<-adonis2(distDWL.bc~Description, strata= Treat, data=dvpostWL.grps, permutations = 999, method="bray")
DWLTreat.div
```


Subset the data for Portola Staging
First subset the PS site from both 2015 and 2017
```{r subset PS}
prevpostPS.mat=comm.mat[comm.grps$Site=="PS",]
prevpostPS.grps=comm.grps[comm.grps$Site=="PS",]
distPS.bc<-vegdist(prevpostPS.mat, method='bray', na.rm=TRUE)
PSTreat.div<-adonis2(distPS.bc~Description, strata= Treat, data=prevpostPS.grps, permutations = 999, method="bray")
PSTreat.div
dim(prevpostPS.grps)
#View(prevpostPS.grps)
```

Next subset the data from the PS site in 2017 with the donor site
```{r}
dvpostPS.mat=comm.mat[(comm.grps$Site=="PS" & comm.grps$Description=="RecipientPost") | comm.grps$Site=="DS",]
dvpostPS.grps=comm.grps[(comm.grps$Site=="PS" & comm.grps$Description=="RecipientPost") | comm.grps$Site=="DS",]
distDPS.bc<-vegdist(dvpostPS.mat, method='bray', na.rm=TRUE)
DPSTreat.div<-adonis2(distDPS.bc~Description, strata= Treat, data=dvpostPS.grps, permutations = 999, method="bray")
DPSTreat.div
dim(dvpostPS.grps)
```

Subset the data
First subset the site (Hicks Haul) from both 2015 and 2017
```{r subset PS}
prevpostHH.mat=comm.mat[comm.grps$Site=="HH",]
prevpostHH.grps=comm.grps[comm.grps$Site=="HH",]
distHH.bc<-vegdist(prevpostHH.mat, method='bray', na.rm=TRUE)
HHTreat.div<-adonis2(distHH.bc~Description, strata= Treat, data=prevpostHH.grps, permutations = 999, method="bray")
HHTreat.div
dim(prevpostHH.grps)
#View(prevpostHH.grps)
```

Next subset the data from the HH site in 2017 versus the donor site
```{r}
dvpostHH.mat=comm.mat[(comm.grps$Site=="HH" & comm.grps$Description=="RecipientPost") | comm.grps$Site=="HH",]
dvpostHH.grps=comm.grps[(comm.grps$Site=="HH" & comm.grps$Description=="RecipientPost") | comm.grps$Site=="HH",]
distDHH.bc<-vegdist(dvpostHH.mat, method='bray', na.rm=TRUE)
DHHTreat.div<-adonis2(distDHH.bc~Description, strata= Treat, data=dvpostHH.grps, permutations = 999, method="bray")
DHHTreat.div
dim(dvpostHH.grps)
```
Analysis of the topsoil thickness treatments for West Loma

##How do we figure out the order to be able to mark down which order the treatments are appearing?
```{r}
postTreatWL.mat=comm.mat[comm.grps$Site=="WL",]
postTreatWL.grps=comm.grps[comm.grps$Site=="WL",]
distTWL.bc<-vegdist(postTreatWL.mat, method='bray', na.rm=TRUE)

#View(postTreatWL.grps)

contr.mineCD <- function(...) cbind(c(-1,1,0,0,0,0))
WLTreatCD<-adonis2(distTWL.bc~Treat, data=postTreatWL.grps, permutations = 999, method="bray",contr.unordered = "contr.mineCD")
WLTreatCD

contr.mineCT <- function(...) cbind(c(-1,0,1,0,0,0))
WLTreatCT<-adonis2(distTWL.bc~Treat, data=postTreatWL.grps, permutations = 999, method="bray",contr.unordered = "contr.mineCT")
WLTreatCT

contr.mineOC <- function(...) cbind(c(-1,0,0,0,0,1))
WLTreatOC<-adonis2(distTWL.bc~Treat, data=postTreatWL.grps, permutations = 999, method="bray",contr.unordered = "contr.mineOC")
WLTreatOC


postTreatWL.div<-adonis2(distWL.bc~Description, strata= Treat, data=postTreatWL.grps, permutations = 999, method="bray")
postTreatWL.div
dim(postTreatWL.grps)
#View(postTreatWL.grps)


dvpostWL.mat=comm.mat[(comm.grps$Site=="WL" & comm.grps$Description=="RecipientPost") | comm.grps$Site=="DS",]
dvpostWL.grps=comm.grps[(comm.grps$Site=="WL" & comm.grps$Description=="RecipientPost") | comm.grps$Site=="DS",]
distDWL.bc<-vegdist(dvpostWL.mat, method='bray', na.rm=TRUE)
DWLTreat.div<-adonis2(distDWL.bc~Description, strata= Treat, data=dvpostWL.grps, permutations = 999, method="bray")
DWLTreat.div
dim(dvpostWL.grps)
```


Analysis of the treatments for Portola Staging

```{r subset Treatments of topsoil thickess PS}
postTreatPS.mat=comm.mat[comm.grps$Site=="PS",]
postTreatPS.grps=comm.grps[comm.grps$Site=="PS",]
distTPS.bc<-vegdist(postTreatPS.mat, method='bray', na.rm=TRUE)

#View(postTreatPS.grps)

contr.mineCD <- function(...) cbind(c(-1,1,0,0,0,0))
PSTreatCD<-adonis2(distTPS.bc~Treat, data=postTreatPS.grps, permutations = 999, method="bray",contr.unordered = "contr.mineCD")
PSTreatCD

contr.mineCT <- function(...) cbind(c(-1,0,1,0,0,0))
PSTreatCT<-adonis2(distTPS.bc~Treat, data=postTreatPS.grps, permutations = 999, method="bray",contr.unordered = "contr.mineCT")
PSTreatCT

contr.mineOC <- function(...) cbind(c(-1,0,0,0,0,1))
PSTreatOC<-adonis2(distTPS.bc~Treat, data=postTreatPS.grps, permutations = 999, method="bray",contr.unordered = "contr.mineOC")
PSTreatOC


postTreatPS.div<-adonis2(distPS.bc~Description, strata= Treat, data=postTreatPS.grps, permutations = 999, method="bray")
postTreatPS.div
dim(postTreatPS.grps)
#View(postTreatPS.grps)


dvpostPS.mat=comm.mat[(comm.grps$Site=="PS" & comm.grps$Description=="RecipientPost") | comm.grps$Site=="DS",]
dvpostPS.grps=comm.grps[(comm.grps$Site=="PS" & comm.grps$Description=="RecipientPost") | comm.grps$Site=="DS",]
distDPS.bc<-vegdist(dvpostPS.mat, method='bray', na.rm=TRUE)
DPSTreat.div<-adonis2(distDPS.bc~Description, strata= Treat, data=dvpostPS.grps, permutations = 999, method="bray")
DPSTreat.div
dim(dvpostPS.grps)
```
Analysis of the topsoil thickness treatments for Hicks Haull
```{r}
postTreatHH.mat=comm.mat[comm.grps$Site=="HH",]
postTreatHH.grps=comm.grps[comm.grps$Site=="HH",]
distTHH.bc<-vegdist(postTreatHH.mat, method='bray', na.rm=TRUE)

#View(postTreatHH.grps)

contr.mineCD <- function(...) cbind(c(-1,1,0,0,0,0))
HHTreatCD<-adonis2(distTHH.bc~Treat, data=postTreatHH.grps, permutations = 999, method="bray",contr.unordered = "contr.mineCD")
HHTreatCD

contr.mineCT <- function(...) cbind(c(-1,0,1,0,0,0))
HHTreatCT<-adonis2(distTHH.bc~Treat, data=postTreatHH.grps, permutations = 999, method="bray",contr.unordered = "contr.mineCT")
HHTreatCT

contr.mineOC <- function(...) cbind(c(-1,0,0,0,0,1))
HHTreatOC<-adonis2(distTHH.bc~Treat, data=postTreatHH.grps, permutations = 999, method="bray",contr.unordered = "contr.mineOC")
HHTreatOC


postTreatHH.div<-adonis2(distHH.bc~Description, strata= Treat, data=postTreatHH.grps, permutations = 999, method="bray")
postTreatHH.div
dim(postTreatHH.grps)
#View(postTreatHH.grps)


dvpostHH.mat=comm.mat[(comm.grps$Site=="HH" & comm.grps$Description=="RecipientPost") | comm.grps$Site=="DS",]
dvpostHH.grps=comm.grps[(comm.grps$Site=="HH" & comm.grps$Description=="RecipientPost") | comm.grps$Site=="DS",]
distDHH.bc<-vegdist(dvpostHH.mat, method='bray', na.rm=TRUE)
DHHTreat.div<-adonis2(distDHH.bc~Description, strata= Treat, data=dvpostHH.grps, permutations = 999, method="bray")
DHHTreat.div
dim(dvpostHH.grps)
```

```{r test code}
str(ssuspeciesREADRICHlong)
tail(ssuspeciesREADRICHlong)
y<-ssuspeciesREADRICHlong$HL
str(y)
H<-ssuguildRICH$HL
S<-ssuguildRICH$Site

length(S)
length(D)
?lm
lm(y~D)

HSite<-lm(y ~ S)
HSite
summary(HSite)

HD<-lm(y~D)
HD
summary(HD)

HSD<-lm(y~S*D)
summary(HSD)


HSiteG<-glm(y ~ S)
HSiteG
summary(HSiteG)

HDG<-glm(y~D)
HDG
summary(HDG)

HSDG<-glm(y~S*D)
summary(HSDG)

glm(y~D)
G_SRhizRich<-glm(y~S)
str(G_SRhizRich)

G_DRhizRich<-glm(y~D)
str(G_DRhizRich)
summary(G_DRhizRich)

DSRhizRich<-lm(y~S*D)
str(DSRhizRich)

summary(DSRhizRich)
lm(y~D*S)
lm(y~D+S)
?glm
glm(y ~ D)



```

```{r modeling hyphal length for the variable without community dynamics}


## mapping data
hyp<-fread('salhyp.txt', header=TRUE)
hyp$Site<-as.character(hyp$Site)
hyp$Rep<-as.factor(hyp$Rep)
hyp$Samp<-as.factor(hyp$Samp)
hyp$Treat<-as.factor(hyp$Treat)
hyp$HL<-as.numeric(hyp$HL)
str(hyp)

tail(hyp)
y<-hyp$HL
str(y)
H<-hyp$HL
S<-hyp$Site
Tr<-hyp$Treat
Yr<-hyp$Yr
Smp<-hyp$Smp


length(S)
length(Tr)
?lm
lm(y~Tr)

HYSite<-lm(y ~ S)
HYSite
summary(HYSite)

HYTr<-lm(y~Tr)
HYTr
summary(HYTr)

HYSTr<-lm(y~S*Tr)
summary(HYSTr)


HYSiteG<-glm(y ~ S)
HYSiteG
summary(HYSiteG)

HTrG<-glm(y~Tr)
HTrG
summary(HTrG)

HYSTrG<-glm(y~S*Tr)
summary(HYSTrG)

HYSTrG2<-glm(y~S+Tr)
summary(HYSTrG2)



```


```{r permanova test}

set.seed(304)
?vegdist

## are the results the same with other (non evolutionary) dissimiarlity indices?
#dist.j<-vegdist(ssuspeciesREADRICHlong[,-1], method='jaccard')
#dist.bc<-vegdist(ssuspeciesREADRICHlong[,-1], method='bray', na.rm=TRUE)
#dist.j<-vegdist(comm.mat, method='jaccard')
dist.bc<-vegdist(comm.mat, method='bray', na.rm=TRUE)
AMTreat.div<-adonis2(dist.bc~Treat, data=comm.grps, permutations = 999, method="bray")
AMTreat.div

AMTD.div<-adonis2(dist.bc~Treat+Description, data=comm.grps, permutations = 999, method="bray")
AMTD.div

AMTSD.div<-adonis2(dist.bc~Treat+Site*Description, data=comm.grps, permutations = 999, method="bray")
AMTSD.div

#AMD_ST_J.div<-adonis2(dist.bc~Description+Site*Treat, data=comm.grps, permutations = 999, method="bray")
#AMD_ST_J.div

AMD_ST_BC.div<-adonis2(dist.bc~Description+Site+Treat, data=comm.grps, permutations = 999, method="bray")
AMD_ST_BC.div

```
```{r}
#dist.bc<-vegdist(comm.mat, method='bray', na.rm=TRUE)
AMHL.div<-adonis2(dist.bc~HL, data=comm.grps, permutations = 999, method="bray")
AMHL.div

AMHLD.div<-adonis2(dist.bc~HL+Description, data=comm.grps, permutations = 999, method="bray")
AMHLD.div

AMHLbyD.div<-adonis2(dist.bc~HL*Description, data=comm.grps, permutations = 999, method="bray")
AMHLbyD.div

AMTSD.div<-adonis2(dist.bc~Treat+Site*Description, data=comm.grps, permutations = 999, method="bray")
AMTSD.div

#AMD_ST_J.div<-adonis2(dist.bc~Description+Site*Treat, data=comm.grps, permutations = 999, method="bray")
#AMD_ST_J.div

AMD_ST_BC.div<-adonis2(dist.bc~Description+Site+Treat, data=comm.grps, permutations = 999, method="bray")
AMD_ST_BC.div
```

#Depending on what comes first in the model, we see different significance of these factors

```{r}
AMTreat.div<-adonis2(dist.bc~Treat*Description, data=comm.grps, permutations = 999, method="bray")
AMTreat.div
```

```{r}



amfMDS<-metaMDS(comm.mat, distance="bray", k=2, trymax=35, autotransform=TRUE) ##k is the number of dimensions
amfMDS ##metaMDS takes eaither a distance matrix or your community matrix (then requires method for 'distance=')

stressplot(amfMDS)

#install.packages('ggplot2') ##plotting package
library(ggplot2)

NMDS1 <- amfMDS$points[,1] ##also found using scores(amfMDS)
NMDS2 <- amfMDS$points[,2]
?cbind
amf.plot<-cbind(comm.grps, NMDS1, NMDS2, comm.mat)
p<-ggplot(amf.plot, aes(NMDS1, NMDS2, color=Year))+
  geom_point(position=position_jitter(.1), shape=3)+##separates overlapping points
  stat_ellipse(type='t',size =1)+ ##draws 95% confidence interval ellipses  
  theme_minimal()
p

plot<-ggplot(amf.plot, aes(NMDS1, NMDS2, color=Treat))+
  stat_ellipse(type='t',size =1)+
  theme_minimal()+geom_text(data=amf.plot,aes(NMDS1, NMDS2, label=Site), position=position_jitter(.35))+
  annotate("text", x=min(NMDS1), y=min(NMDS2), label=paste('Stress =',round(amfMDS$stress,3))) #add stress to plot
plot

```
Subset the community data matrix
Number of samples that are left
```{r subset dm (bray)}
summary(comm.grps)
class(comm.mat)

#subset the comm.mat and comm.grps
#x=comm.mat[comm.grps$Year == "2015",]
#y=comm.grps[comm.grps$Year == "2015",]

```
commented out some difficult lines
```{r}
#what is x?

#SSMDS<-metaMDS(x, distance="bray", k = 2, trymax = 35, autotransform = TRUE) ##k is the number of dimensions
#SSMDS ##metaMDS takes eaither a distance matrix or your community matrix (then requires method for 'distance=')

#stressplot(SSMDS)

#install.packages('ggplot2') ##plotting package
library(ggplot2)

#NMDS1 <- SSMDS$points[,1] ##also found using scores(amfMDS)
#NMDS2 <- SSMDS$points[,2]
?cbind

```

The code was stopping at this point, and I created a new chunk below

SSamf.plot<-cbind(y, NMDS1, NMDS2, x)

Sp<-ggplot(SSamf.plot, aes(NMDS1, NMDS2, color=Site))+
  geom_point(position=position_jitter(.1), shape=7)+##separates overlapping points
 # stat_ellipse(type='t',size =1)+ ##draws 95% confidence interval ellipses
  theme_minimal()
Sp

SSp<-ggplot(SSamf.plot, aes(NMDS1, NMDS2, color=Site))+
  geom_point(position=position_jitter(.1), shape=3)+##separates overlapping points
  stat_ellipse(type='t',size =1)+ ##draws 95% confidence interval ellipses
  theme_minimal()
SSp

plot<-ggplot(SSamf.plot, aes(NMDS1, NMDS2, color=Treat))+
  stat_ellipse(type='t',size =1)+
  theme_minimal()+geom_text(data=amf.plot,aes(NMDS1, NMDS2, label=Site), position=position_jitter(.35))+
  annotate("text", x=min(NMDS1), y=min(NMDS2), label=paste('Stress =',round(amfMDS$stress,3))) #add stress to plot
plot

#ad.bc<-adonis2(dist.bc~Treat+Metadata1+Metadata, data=grps, permutations=1000)
#ad.bc

Examining the statistic support for increased rhizophilic richness in recipientpost plots
```{r glm on Rhizophilic richness and metadata}

ssu.fg <- ssu %>%
  mutate(Functional.Group = case_when(
    ssufamily %in% c('Glomeraceae','Claroideoglomeraceae', 'Paraglomeraceae') ~ 'Rhizophilic',
    ssufamily %in% c('Gigasporaceae', 'Diversisporaceae') ~ 'Edaphophilic',
    ssufamily %in% c('Ambisporaceae', 'Archaeosporaceae','Acaulosporaceae') ~ 'Ancestral'
  ))

ssul <-melt(ssu.fg, variable.name='ID',value.name='ssureads')
str(ssul)

ssuguildREADRICH<- data.frame(ssul %>%
                                group_by(ID,Functional.Group) %>%
                                summarise(OTU_Richness_Sample = length(unique(ssuotu[ssureads>0])),
                                         Read_Abundance_Sample = sum(ssureads)))
ssufamily <- data.frame(ssul %>%
                          group_by(ID, ssufamily) %>%
                          summarise(Family_OTU_Richness = length(unique(ssuotu[ssureads>0])), 
                                    Family_Read_Abundance = sum(ssureads)))

colnames(metassu) # need to edit for appropriate headers
names(metassu)[names(metassu) == 'SampleID2'] <- 'ID'

ssufamily<-ssufamily%>%
  left_join(metassu, by='ID')
str(ssufamily)

ssuguildREADRICH<-ssuguildREADRICH%>%
  left_join(metassu, by='ID')
str(ssuguildREADRICH)  

filename<-paste0(date, '_ssu_funcguild_read_rich.csv')
write.csv(ssuguildREADRICH, file = filename, row.names=FALSE)

LssufamilyOTURICH <- dcast(ssufamily, ID ~ ssufamily, value.var = "Family_OTU_Richness",  fun.aggregate = sum )
LssufamilyOTUREAD <- dcast(ssufamily, ID ~ ssufamily, value.var = "Family_Read_Abundance",  fun.aggregate = sum )

head(LssufamilyOTUREAD)

ssuguildREADRICHlong<- data.frame(ssul %>%
                                group_by(ID) %>%
                                summarise(OTU_Richness_Sample = length(unique(ssuotu[ssureads>0])),
                                Ancestral_Richness = length(unique(ssuotu[ssureads>0 & Functional.Group =="Ancestral"])),
                                Edaphophilic_Richness = length(unique(ssuotu[ssureads>0 & Functional.Group =="Edaphophilic"])),
                                Rhizophilic_Richness = length(unique(ssuotu[ssureads>0 & Functional.Group =="Rhizophilic"])),
                                Ancestral_Read_Abundance = sum(ssureads[Functional.Group == "Ancestral"]),
                                Edaphophilic_Read_Abundance = sum(ssureads[Functional.Group == "Edaphophilic"]),
                                Rhizophilic_Read_Abundance = sum(ssureads[Functional.Group == "Rhizophilic"]),
                                Read_Abundance_Sample = sum(ssureads)))
View(ssuguildREADRICHlong)
ssuguildREADRICHlong <- merge(ssuguildREADRICHlong, metassu, by = "ID")

filename<-paste0(date, '_ssu_funcguild_read_rich.csv')
write.csv(ssuguildREADRICHlong, file = filename, row.names=FALSE)

str(ssuguildREADRICHlong)

ssuguildREAD <- ssul %>% 
  group_by(ID) %>%
  summarise(Ancestral_Read_Abundance = sum(ssureads[Functional.Group == "Ancestral"]),
            Edaphophilic_Read_Abundance = sum(ssureads[Functional.Group == "Edaphophilic"]),
            Rhizophilic_Read_Abundance = sum(ssureads[Functional.Group == "Rhizophilic"]))


ssuguildRICH<- ssul %>%
  group_by(ID) %>%
  summarise(OTU_Richness_Sample = length(unique(ssuotu[ssureads>0])),
            Ancestral_Richness = length(unique(ssuotu[ssureads>0 & Functional.Group =="Ancestral"])),
            Edaphophilic_Richness = length(unique(ssuotu[ssureads>0 & Functional.Group =="Edaphophilic"])),
            Rhizophilic_Richness = length(unique(ssuotu[ssureads>0 & Functional.Group =="Rhizophilic"]))) 
head(ssuguildRICH)

ssuguildRICH<-merge(ssuguildRICH, metassu, by="ID")
ssuguildREAD<-merge(ssuguildREAD, metassu, by="ID")
str(ssuguildRICH)
str(ssuguildREAD)


y<-ssuguildRICH$Rhizophilic_Richness
str(y)
D<-ssuguildRICH$Description
S<-ssuguildRICH$Site

length(S)
length(D)
?lm
#lm(y~D)

SRhizRich<-lm(y ~ S)
str(SRhizRich)

DRhizRich<-lm(y~D)
str(DRhizRich)

DSRhizRich<-lm(y~S*D)
str(DSRhizRich)

summary(DSRhizRich)

y<-ssuguildRICH$Rhizophilic_Richness
str(y)
D<-ssuguildRICH$Description
S<-ssuguildRICH$Site
length(S)
length(D)
?lm

glm(y~D)
G_SRhizRich<-glm(y~S)
str(G_SRhizRich)

G_DRhizRich<-glm(y~D)
str(G_DRhizRich)
summary(G_DRhizRich)

DSRhizRich<-lm(y~S*D)
str(DSRhizRich)

summary(DSRhizRich)
lm(y~D*S)
lm(y~D+S)
?glm
glm(y ~ D)

 #Description+Site

```
**start '2017_16_07_SSU_Boxplots.R'** 
Plotting
```{r}
#richness
plot.df<-ssuguildREADRICH
str(plot.df)

richbox <- ggplot(plot.df, aes(x = Functional.Group , y = OTU_Richness_Sample)) + geom_boxplot(aes(fill = Description)) 
richbox

richbox <- richbox + theme_bw(base_size = 15) + xlab("Functional Group") +ylab("AMF Taxa Richness")    
richbox

richbox <-richbox + scale_fill_manual(values=c('red', 'darkslateblue','gold3'))
richbox
```  
```{r, eval=FALSE}
##reads
plot.read<-ssuguildREADRICH
str(plot.read)

reachbox <- ggplot(plot.read, aes(x = Functional.Group, y = OTU_Richness_Sample)) + geom_boxplot(aes(fill = Description)) 
reachbox

reachbox <- reachbox + theme_bw(base_size = 15) + xlab("Functional Group") +ylab("AMF Taxa Reads")    
reachbox

reachbox <-reachbox + scale_fill_manual(values=c('red', 'darkslateblue','gold3'))
reachbox
```
ADAPTED FROM #GLMM for roots and soil OTU Richness SSU by functional group-modified from "GLM_NAU_6_2017"
#---different models for each functional group
#Author: Michala Phillips
#MODIFY FOR THIS DATA
```{r}
library(car)
require(MASS)
library(lme4)
```

#Choose distribution based on data
# find the right distribution for data
```{r}

ssuguildREADRICHlong$OTU_Richness_Sample.t <- ssuguildREADRICHlong$OTU_Richness_Sample + 1
qqp(ssuguildREADRICHlong$OTU_Richness_Sample.t, "norm")

#LOGNORMAL
qqp(ssuguildREADRICHlong$OTU_Richness_Sample, "lnorm")

#NEG BINOMIAL
nbinom <- fitdistr(ssuguildREADRICHlong$OTU_Richness_Sample.t, "Negative Binomial")
qqp(ssuguildREADRICHlong$OTU_Richness_Sample.t, "nbinom", size = nbinom$estimate[[1]], mu = nbinom$estimate[[2]])

#POISSON
poisson <- fitdistr(ssuguildREADRICHlong$OTU_Richness_Sample.t, "Poisson")
qqp(ssuguildREADRICHlong$OTU_Richness_Sample.t, "pois", lambda = poisson$estimate)

#GAMMA
gamma <- fitdistr(ssuguildREADRICHlong$OTU_Richness_Sample.t, "gamma")
qqp(ssuguildREADRICHlong$OTU_Richness_Sample.t, "gamma", shape = gamma$estimate[[1]], rate = gamma$estimate[[2]])
#
```
```{r glm gaussian}
modelingAMF <- glm(OTU_Richness_Sample.t ~ Site + Treat, data = ssuguildREADRICHlong, family = gaussian(link = "identity"))
modelingAMF

modelingAMF_MP <- glm(OTU_Richness_Sample.t ~ Site + Treat + Description + Rep + Year, data = ssuguildREADRICHlong, family = gaussian(link = "identity"))
plot(modelingAMF_MP)
stepAIC(modelingAMF_MP) 
modelingAMF_MP


stepAIC(modelingAMF) 
modelingAMFfinal <- glm(OTU_Richness_Sample.t ~ Site + Treat, family = gaussian(link = "identity"), data = ssuguildREADRICHlong)

summary(modelingAMFfinal)
plot(modelingAMFfinal)


```
```{r modeling }
modelingAMF <- glm(OTU_Richness_Sample.t ~ Site + Treat, data = ssuguildREADRICHlong, family = gaussian(link = "identity"))
modelingAMF

stepAIC(modelingAMF) 
modelingAMFfinal <- glm(OTU_Richness_Sample.t ~ Site + Treat, family = gaussian(link = "identity"), data = ssuguildREADRICHlong)

summary(modelingAMFfinal)
plot(modelingAMFfinal)
```
#Working on examining other variables 
```{r}
modelingAMF <- glm(OTU_Richness_Sample.t ~ Treat + Site, data = ssuguildREADRICHlong, family = gaussian(link = "identity"))
```
Plotting
```{r}
plot.df<-ssuguildREADRICH
str(plot.df)

richbox <- ggplot(plot.df, aes(x = Functional.Group , y = OTU_Richness_Sample)) + geom_boxplot(aes(fill = Description)) 
richbox

richbox <- richbox + theme_bw(base_size = 15) + xlab("Functional Group") +ylab("AMF Taxa Richness")    
richbox

richbox <-richbox + scale_fill_manual(values=c('red', 'darkslateblue','gold3'))
richbox

```

ADAPTED FROM #GLMM for roots and soil OTU Richness SSU by functional group-modified from "GLM_NAU_6_2017"
#---different models for each functional group
#Author: Michala Phillips
#MODIFY FOR THIS DATA
#Tried with negative binomial but it didn't work
```{r IntroPermanova}
#salvage.div<-adonis2(bird.dist~DIVERSITY, data=birds, permutations = 999, method="bray", strata="PLOT")
#bird.div


```

